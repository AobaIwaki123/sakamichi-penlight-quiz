---
description: "ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã¨Jestè¨­å®šã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³"
globs: **/__tests__/**,**/test/**,*.test.ts,*.test.tsx,*.spec.ts,*.spec.tsx,jest.config.js,jest.setup.js
---

# ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ãƒ»è‡ªå‹•åŒ–ã‚¬ã‚¤ãƒ‰

## ãƒ†ã‚¹ãƒˆç’°å¢ƒæ§‹æˆ

### ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- **ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ**: Jest + Testing Library
- **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**: [jest.config.js](mdc:view/jest.config.js)
- **ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**: [jest.setup.js](mdc:view/jest.setup.js)
- **å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**: `pnpm test`, `pnpm test:watch`

### Jestè¨­å®š
```javascript
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
  moduleNameMapper: {
    '^@/(.*)$': '<rootDir>/$1',
  },
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  testPathIgnorePatterns: ['<rootDir>/node_modules/', '<rootDir>/.next/'],
};
```

## Zustandã‚¹ãƒˆã‚¢ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### åŸºæœ¬ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³
```typescript
// useSelectedMemberStore.test.ts ã®å®Ÿä¾‹
import { useSelectedMemberStore } from '@/stores/useSelectedMemberStore';
import type { Member } from '@/types/Member';

// APIé–¢æ•°ã®ãƒ¢ãƒƒã‚¯åŒ–
jest.mock('@/api/bq/getHinatazakaMember', () => ({
  getHinatazakaMember: jest.fn().mockResolvedValue([
    // ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
  ])
}));

describe('useSelectedMemberStore', () => {
  beforeEach(async () => {
    const store = useSelectedMemberStore.getState();
    await store.setGroup('hinatazaka');
    store.setFilters({});
    store.applyFilters();
  });
  
  // å€‹åˆ¥ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
});
```

### Zustandã‚¹ãƒˆã‚¢ãƒ†ã‚¹ãƒˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

#### 1. ã‚¹ãƒˆã‚¢çŠ¶æ…‹ã®åˆ†é›¢
```typescript
beforeEach(async () => {
  // å„ãƒ†ã‚¹ãƒˆå‰ã«ã‚¹ãƒˆã‚¢ã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ
  const store = useSelectedMemberStore.getState();
  await store.setGroup('hinatazaka');
  store.setFilters({});
  store.applyFilters();
});
```

#### 2. éåŒæœŸå‡¦ç†ã®ãƒ†ã‚¹ãƒˆ
```typescript
test('ãƒ¡ãƒ³ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã®éåŒæœŸå–å¾—', async () => {
  const store = useSelectedMemberStore.getState();
  await store.setGroup('hinatazaka');
  
  expect(store.allMembers).toHaveLength(6);
  expect(store.isLoading).toBe(false);
});
```

#### 3. ãƒ©ãƒ³ãƒ€ãƒ å‡¦ç†ã®ãƒ†ã‚¹ãƒˆ
```typescript
test('é‡è¤‡ãªã—ã§ãƒ¡ãƒ³ãƒãƒ¼ãŒé¸æŠã•ã‚Œã‚‹', () => {
  const store = useSelectedMemberStore.getState();
  const memberIds = new Set<number>();
  const totalMembers = store.filteredMembers.length;
  
  for (let i = 0; i < totalMembers; i++) {
    const member = store.pickRandomMember();
    if (member) {
      expect(memberIds.has(member.id)).toBe(false);
      memberIds.add(member.id);
    }
  }
  
  expect(memberIds.size).toBe(totalMembers);
});
```

#### 4. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆ
```typescript
test('æœŸç”Ÿåˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹', () => {
  const store = useSelectedMemberStore.getState();
  const allMembers = store.allMembers;
  
  const firstGenMembers = allMembers.filter(m => m.gen === '1st');
  expect(firstGenMembers.length).toBe(2);
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨å¾Œã®å‹•ä½œç¢ºèª
  // ...
});
```

## APIé–¢æ•°ã®ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### BigQuery APIã®ãƒ¢ãƒƒã‚¯åŒ–
```typescript
// BigQueryé–¢æ•°ã®ãƒ¢ãƒƒã‚¯
jest.mock('@/api/bq/getHinatazakaMember', () => ({
  getHinatazakaMember: jest.fn().mockResolvedValue([
    {
      id: 1,
      name: 'Test Member',
      nickname: 'TM',
      emoji: 'ğŸŒŸ',
      gen: '1st' as Generation,
      graduated: false,
      penlight1_id: 1,
      penlight2_id: 2,
      type: 'regular',
      url: 'https://example.com/1'
    }
  ])
}));
```

### é–‹ç™ºãƒ»æœ¬ç•ªç’°å¢ƒã®åˆ†å²ãƒ†ã‚¹ãƒˆ
```typescript
describe('ç’°å¢ƒåˆ¥å‹•ä½œãƒ†ã‚¹ãƒˆ', () => {
  test('é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™', () => {
    const originalEnv = process.env.NODE_ENV;
    process.env.NODE_ENV = 'development';
    
    // ãƒ†ã‚¹ãƒˆãƒ­ã‚¸ãƒƒã‚¯
    
    process.env.NODE_ENV = originalEnv;
  });
});
```

## Reactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆ

### Testing Libraryã®ä½¿ç”¨
```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { MemberInfo } from '@/components/Home/MemberInfo/MemberInfo';

describe('MemberInfo ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ', () => {
  test('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹', () => {
    const mockMember = {
      id: 1,
      name: 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒ³ãƒãƒ¼',
      nickname: 'ãƒ†ã‚¹ãƒˆ',
      emoji: 'ğŸŒŸ',
      // ...
    };
    
    render(<MemberInfo member={mockMember} />);
    
    expect(screen.getByText('ãƒ†ã‚¹ãƒˆãƒ¡ãƒ³ãƒãƒ¼')).toBeInTheDocument();
    expect(screen.getByText('ğŸŒŸ')).toBeInTheDocument();
  });
});
```

### Mantineã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ
```typescript
import { MantineProvider } from '@mantine/core';

const renderWithMantine = (component: React.ReactElement) => {
  return render(
    <MantineProvider>
      {component}
    </MantineProvider>
  );
};
```

## ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆ

### useColorControllerã®ãƒ†ã‚¹ãƒˆä¾‹
```typescript
import { renderHook } from '@testing-library/react';
import { useColorController } from '@/hooks/useColorController';

describe('useColorController ãƒ•ãƒƒã‚¯', () => {
  test('æ­£å¸¸ã«ãƒšãƒ³ãƒ©ã‚¤ãƒˆè‰²ã‚’ç®¡ç†ã™ã‚‹', () => {
    const { result } = renderHook(() => useColorController());
    
    // ãƒ•ãƒƒã‚¯ã®å‹•ä½œã‚’ãƒ†ã‚¹ãƒˆ
    expect(result.current.colors).toBeDefined();
  });
});
```

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆ

### BigQueryæ¥ç¶šã‚¨ãƒ©ãƒ¼ã®ãƒ†ã‚¹ãƒˆ
```typescript
test('BigQueryæ¥ç¶šã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯', async () => {
  // BigQueryé–¢æ•°ã‚’ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹ã‚ˆã†ã«ãƒ¢ãƒƒã‚¯
  const mockGetMembers = jest.fn().mockRejectedValue(new Error('Connection failed'));
  
  // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ç¢ºèª
  try {
    await mockGetMembers();
  } catch (error) {
    expect(error.message).toBe('Connection failed');
  }
});
```

### ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆ
```typescript
test('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', () => {
  const errorMessage = 'ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
  expect(errorMessage).toMatch(/ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±/);
  expect(errorMessage).toMatch(/å†è©¦è¡Œ/);
});
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

### ãƒ©ãƒ³ãƒ€ãƒ é¸æŠã®åˆ†æ•£æ€§ãƒ†ã‚¹ãƒˆ
```typescript
test('ãƒ©ãƒ³ãƒ€ãƒ é¸æŠã®åˆ†æ•£æ€§ï¼ˆ10å›è©¦è¡Œã§8å›ä»¥ä¸Šç•°ãªã‚‹é †åºï¼‰', () => {
  const store = useSelectedMemberStore.getState();
  const loops: number[][] = [];
  
  for (let loop = 0; loop < 10; loop++) {
    store.shuffleMembers();
    const loopOrder: number[] = [];
    
    // 1ãƒ«ãƒ¼ãƒ—åˆ†ã®é¸æŠé †åºã‚’è¨˜éŒ²
    // ...
    
    loops.push(loopOrder);
  }
  
  const uniqueOrders = new Set<string>();
  for (const loop of loops) {
    uniqueOrders.add(JSON.stringify(loop));
  }
  
  expect(uniqueOrders.size).toBeGreaterThanOrEqual(8);
});
```

## ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ»CIæˆ¦ç•¥

### Docker Composeã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆæ¨å¥¨ï¼‰
ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€ä¸€è²«ã—ãŸç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã®ãŸã‚Docker Composeã‚’ä½¿ç”¨ã™ã‚‹ã€‚

```bash
# Docker Composeã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•ï¼ˆåˆå›ã®ã¿ï¼‰
docker compose up -d view

# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
docker compose exec view npm test

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè¡Œ
docker compose exec view npm test -- --testPathPattern=api/bq

# ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰
docker compose exec view npm test -- --watch

# ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãå®Ÿè¡Œ
docker compose exec view npm test -- --coverage

# Docker Composeã‚µãƒ¼ãƒ“ã‚¹ã®åœæ­¢
docker compose down
```

### ãƒ­ãƒ¼ã‚«ãƒ«ç›´æ¥å®Ÿè¡Œï¼ˆéæ¨å¥¨ï¼‰
Dockerç’°å¢ƒãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ã¿ä½¿ç”¨ã™ã‚‹ï¼š

```bash
# view ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd view/

# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pnpm test

# ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰
pnpm test:watch

# ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãå®Ÿè¡Œ
pnpm test --coverage
```

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã®æ³¨æ„äº‹é …
- **å¿…é ˆ**: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¯ `docker compose exec view` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹
- **ç’°å¢ƒå¤‰æ•°**: Docker Composeç’°å¢ƒã§ã¯ `USE_MOCK=true` ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨­å®šã•ã‚Œã‚‹
- **ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•**: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã« `docker compose up -d view` ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ã™ã‚‹
- **ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**: ä½œæ¥­å®Œäº†å¾Œã¯ `docker compose down` ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’è§£æ”¾ã™ã‚‹

### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
```
view/__tests__/
â”œâ”€â”€ stores/                 # Zustandã‚¹ãƒˆã‚¢ã®ãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ useSelectedMemberStore.test.ts
â”‚   â”œâ”€â”€ useColorStore.test.ts
â”‚   â””â”€â”€ ...
â”œâ”€â”€ components/            # Reactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ Home/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ api/                   # APIé–¢æ•°ã®ãƒ†ã‚¹ãƒˆ
â”‚   â””â”€â”€ bq/
â””â”€â”€ hooks/                 # ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆ
```

## ãƒ†ã‚¹ãƒˆå“è³ªåŸºæº–

### ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™
- **ã‚¹ãƒˆã‚¢**: 90%ä»¥ä¸Š
- **APIé–¢æ•°**: 80%ä»¥ä¸Š
- **é‡è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**: 70%ä»¥ä¸Š

### ãƒ†ã‚¹ãƒˆå¿…é ˆé …ç›®
1. **ã‚¹ãƒˆã‚¢ã®çŠ¶æ…‹å¤‰æ›´**: å…¨ã¦ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ†ã‚¹ãƒˆ
2. **APIé–¢æ•°**: æ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ä¸¡æ–¹ã‚’ãƒ†ã‚¹ãƒˆ
3. **ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯**: å…¨ã¦ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çµ„ã¿åˆã‚ã›ã‚’ãƒ†ã‚¹ãƒˆ
4. **ãƒ©ãƒ³ãƒ€ãƒ å‡¦ç†**: åˆ†æ•£æ€§ã¨é‡è¤‡é˜²æ­¢ã‚’ãƒ†ã‚¹ãƒˆ
5. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ†ã‚¹ãƒˆ

## ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### æ—¥æœ¬èªã§ã®ãƒ†ã‚¹ãƒˆè¨˜è¿°
```typescript
describe('ãƒ¡ãƒ³ãƒãƒ¼é¸æŠã‚¹ãƒˆã‚¢', () => {
  test('é‡è¤‡ãªã—ã§ãƒ¡ãƒ³ãƒãƒ¼ãŒé¸æŠã•ã‚Œã‚‹', () => {
    // ãƒ†ã‚¹ãƒˆãƒ­ã‚¸ãƒƒã‚¯
  });
  
  test('æœŸç”Ÿåˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹', () => {
    // ãƒ†ã‚¹ãƒˆãƒ­ã‚¸ãƒƒã‚¯
  });
});
```

### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†
- ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã¯å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¨ä¸€è‡´ã•ã›ã‚‹
- æ—¥æœ¬èªã®ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼ˆMemberåã€ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç­‰ï¼‰
- BigQuery APIãƒ¢ãƒƒã‚¯ã¯é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã®å‹•ä½œã¨ä¸€è‡´ã•ã›ã‚‹

### éåŒæœŸå‡¦ç†ã®ãƒ†ã‚¹ãƒˆ
- `async/await`ã‚’é©åˆ‡ã«ä½¿ç”¨
- Promiseè§£æ±ºå¾Œã®çŠ¶æ…‹å¤‰æ›´ã‚’ç¢ºèª
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’é©åˆ‡ã«è¨­å®š

### ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢
- å„ãƒ†ã‚¹ãƒˆå¾Œã®ã‚¹ãƒˆã‚¢ãƒªã‚»ãƒƒãƒˆ
- ãƒ¢ãƒƒã‚¯é–¢æ•°ã®ã‚¯ãƒªã‚¢
- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®é©åˆ‡ãªå‰Šé™¤
