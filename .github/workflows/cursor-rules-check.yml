name: cursor-rules-check
run-name: Cursor Rules ãƒã‚§ãƒƒã‚¯

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

defaults:
  run:
    shell: bash

jobs:
  check-cursor-rules-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: PRæƒ…å ±ã‚’å–å¾—
        id: pr-info
        run: |
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "PR Title: ${{ github.event.pull_request.title }}"
          echo "PR Labels: ${{ join(github.event.pull_request.labels.*.name, ', ') }}"

      - name: å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†æ
        id: analyze-changes
        run: |
          echo "=== å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ ==="
          
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          echo "$CHANGED_FILES"
          
          # Cursor Rulesæ›´æ–°ãŒå¿…è¦ã‹ãƒã‚§ãƒƒã‚¯
          NEEDS_RULES_UPDATE=false
          
          # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–¢é€£ã®å¤‰æ›´
          if echo "$CHANGED_FILES" | grep -E '^view/(components|stores|hooks|types|api)/' > /dev/null; then
            echo "::notice::ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ/ã‚¹ãƒˆã‚¢/ãƒ•ãƒƒã‚¯ã®å¤‰æ›´ã‚’æ¤œå‡º"
            NEEDS_RULES_UPDATE=true
          fi
          
          # ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£é–¢é€£ã®å¤‰æ›´
          if echo "$CHANGED_FILES" | grep -E '^view/(app|layout)/' > /dev/null; then
            echo "::notice::ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£é–¢é€£ã®å¤‰æ›´ã‚’æ¤œå‡º"
            NEEDS_RULES_UPDATE=true
          fi
          
          # BigQuery/Dataformé–¢é€£ã®å¤‰æ›´
          if echo "$CHANGED_FILES" | grep -E '^definitions/' > /dev/null; then
            echo "::notice::Dataformãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å¤‰æ›´ã‚’æ¤œå‡º"
            NEEDS_RULES_UPDATE=true
          fi
          
          # ã‚¤ãƒ³ãƒ•ãƒ©é–¢é€£ã®å¤‰æ›´
          if echo "$CHANGED_FILES" | grep -E '^k8s/|^\.github/workflows/' > /dev/null; then
            echo "::notice::ã‚¤ãƒ³ãƒ•ãƒ©ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨­å®šå¤‰æ›´ã‚’æ¤œå‡º"
            NEEDS_RULES_UPDATE=true
          fi
          
          # æ–°ã—ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸/ä¾å­˜é–¢ä¿‚ã®è¿½åŠ 
          if echo "$CHANGED_FILES" | grep -E '^view/(package\.json|pnpm-lock\.yaml)$' > /dev/null; then
            echo "::notice::ä¾å­˜é–¢ä¿‚ã®å¤‰æ›´ã‚’æ¤œå‡º"
            NEEDS_RULES_UPDATE=true
          fi
          
          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´
          if echo "$CHANGED_FILES" | grep -E '\.(config|env)' > /dev/null; then
            echo "::notice::è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’æ¤œå‡º"
            NEEDS_RULES_UPDATE=true
          fi
          
          echo "needs_update=$NEEDS_RULES_UPDATE" >> $GITHUB_OUTPUT

      - name: ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ©ãƒ™ãƒ«ãƒã‚§ãƒƒã‚¯
        id: check-labels
        run: |
          # PRãƒ©ãƒ™ãƒ«ã‚’ç¢ºèª
          LABELS="${{ join(github.event.pull_request.labels.*.name, ',') }}"
          
          HAS_SEMANTIC_LABEL=false
          if [[ "$LABELS" == *"major"* ]] || [[ "$LABELS" == *"minor"* ]] || [[ "$LABELS" == *"patch"* ]]; then
            HAS_SEMANTIC_LABEL=true
            echo "âœ… ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ©ãƒ™ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
          else
            echo "âŒ ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ©ãƒ™ãƒ« (major/minor/patch) ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
          fi
          
          echo "has_semantic_label=$HAS_SEMANTIC_LABEL" >> $GITHUB_OUTPUT
          echo "labels=$LABELS" >> $GITHUB_OUTPUT

      - name: Cursor Rulesæ›´æ–°æ¨å¥¨ã®é€šçŸ¥
        if: steps.analyze-changes.outputs.needs_update == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            
            const needsUpdate = '${{ steps.analyze-changes.outputs.needs_update }}';
            const hasSemanticLabel = '${{ steps.check-labels.outputs.has_semantic_label }}';
            const labels = '${{ steps.check-labels.outputs.labels }}';
            
            let comment = `## ğŸ”„ Cursor Rules æ›´æ–°ãƒã‚§ãƒƒã‚¯çµæœ\n\n`;
            
            if (needsUpdate === 'true') {
              comment += `### âš ï¸ Cursor Rules ã®æ›´æ–°ã‚’æ¨å¥¨ã—ã¾ã™\n\n`;
              comment += `ã“ã®PRã«ã¯ä»¥ä¸‹ã®å¤‰æ›´ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€Cursor Rulesã®æ›´æ–°ãŒæ¨å¥¨ã•ã‚Œã¾ã™ï¼š\n\n`;
              
              // å¤‰æ›´å†…å®¹ã«åŸºã¥ãå…·ä½“çš„ãªæ¨å¥¨äº‹é …
              comment += `#### æ¨å¥¨ã•ã‚Œã‚‹æ›´æ–°é …ç›®\n`;
              comment += `- [ ] \`frontend-architecture.mdc\` - ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ»ã‚¹ãƒˆã‚¢æ§‹æˆã®æ›´æ–°\n`;
              comment += `- [ ] \`deployment-infrastructure.mdc\` - ã‚¤ãƒ³ãƒ•ãƒ©è¨­å®šã®æ›´æ–°\n`;
              comment += `- [ ] \`dataform-pipeline.mdc\` - ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹æˆã®æ›´æ–°\n`;
              comment += `- [ ] \`coding-standards.mdc\` - ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã®ç¢ºèªãƒ»æ›´æ–°\n\n`;
            }
            
            if (hasSemanticLabel === 'false') {
              comment += `### ğŸ·ï¸ ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ©ãƒ™ãƒ«ãŒå¿…è¦ã§ã™\n\n`;
              comment += `ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼š\n`;
              comment += `- \`patch\` - ãƒã‚°ä¿®æ­£ãƒ»å°è¦æ¨¡æ”¹å–„\n`;
              comment += `- \`minor\` - æ–°æ©Ÿèƒ½è¿½åŠ ï¼ˆå¾Œæ–¹äº’æ›æ€§ã‚ã‚Šï¼‰\n`;
              comment += `- \`major\` - ç ´å£Šçš„å¤‰æ›´\n\n`;
            } else {
              comment += `### âœ… ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°\n\n`;
              comment += `ãƒ©ãƒ™ãƒ«è¨­å®šæ¸ˆã¿: \`${labels}\`\n\n`;
            }
            
            comment += `### ğŸ“‹ PRä½œæˆå¾Œã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ\n\n`;
            comment += `- [ ] é©åˆ‡ãªã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ©ãƒ™ãƒ«ã‚’è¨­å®š\n`;
            comment += `- [ ] å¤‰æ›´å†…å®¹ã«å¯¾å¿œã™ã‚‹Cursor Rulesã®æ›´æ–°ã‚’æ¤œè¨\n`;
            comment += `- [ ] ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ»å‹•ä½œç¢ºèªå®Œäº†\n`;
            comment += `- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ï¼ˆå¿…è¦ãªå ´åˆï¼‰\n\n`;
            
            comment += `---\n`;
            comment += `*ã“ã®ãƒã‚§ãƒƒã‚¯ã¯è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚è©³ç´°ã¯ [PRç®¡ç†ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³](.cursor/rules/pr-management.mdc) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚*`;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pull_number,
              body: comment
            });

      - name: ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒ©ãƒ™ãƒ«å¿…é ˆãƒã‚§ãƒƒã‚¯
        if: steps.check-labels.outputs.has_semantic_label == 'false'
        run: |
          echo "::error::ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ©ãƒ™ãƒ« (major/minor/patch) ã®è¨­å®šãŒå¿…è¦ã§ã™"
          echo "PRã«é©åˆ‡ãªãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼š"
          echo "  - patch: ãƒã‚°ä¿®æ­£ãƒ»å°è¦æ¨¡æ”¹å–„"
          echo "  - minor: æ–°æ©Ÿèƒ½è¿½åŠ ï¼ˆå¾Œæ–¹äº’æ›æ€§ã‚ã‚Šï¼‰"
          echo "  - major: ç ´å£Šçš„å¤‰æ›´"
          exit 1