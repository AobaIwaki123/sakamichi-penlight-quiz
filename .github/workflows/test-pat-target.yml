name: test-pat-target
run-name: Test PAT Target Workflow

on:
  push:
    tags:
      - "test-v*.*.*" # test-v1.0.0 のようなテストタグにマッチ
      - "test-*"      # test- で始まるすべてのタグにマッチ
  workflow_dispatch:
    inputs:
      test_tag:
        description: "手動実行用のテストタグ名"
        required: false
        default: "manual-test"

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  test-pat-target-execution:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect Trigger Type
        id: detect-trigger
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "trigger_type=tag_push" >> $GITHUB_OUTPUT
            echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "trigger_type=manual" >> $GITHUB_OUTPUT
            echo "tag_name=${{ github.event.inputs.test_tag }}" >> $GITHUB_OUTPUT
          fi

      - name: PAT Test Result Verification
        env:
          TRIGGER_TYPE: ${{ steps.detect-trigger.outputs.trigger_type }}
          TAG_NAME: ${{ steps.detect-trigger.outputs.tag_name }}
        run: |
          echo "=== PAT権限テスト結果 ==="
          echo "トリガータイプ: ${TRIGGER_TYPE}"
          echo "対象タグ: ${TAG_NAME}"
          echo "実行時刻: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "GitHub Event: ${{ github.event_name }}"
          echo "GitHub Ref: ${{ github.ref }}"
          echo ""
          
          if [ "${TRIGGER_TYPE}" = "tag_push" ]; then
            echo "🎉 SUCCESS: PAT権限でのタグプッシュによるワークフロー起動が成功しました！"
            echo "✅ test-pat-trigger ワークフローから test-pat-target ワークフローの連携が正常に動作"
            echo "✅ PAT_TOKEN を使用したGitHub Actions間の連携が機能することを確認"
            echo ""
            echo "📋 確認された機能:"
            echo "  - PAT_TOKEN によるタグ作成・プッシュ"
            echo "  - タグプッシュイベントによる他ワークフローの自動起動"
            echo "  - GitHub Actions間の連携動作"
          else
            echo "ℹ️  INFO: 手動実行によるテストです"
            echo "タグプッシュによる自動起動をテストするには test-pat-trigger ワークフローを実行してください"
          fi

      - name: Test Environment Information
        run: |
          echo "=== テスト環境情報 ==="
          echo "Runner OS: ${{ runner.os }}"
          echo "GitHub Repository: ${{ github.repository }}"
          echo "GitHub Actor: ${{ github.actor }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run Number: ${{ github.run_number }}"

      - name: Cleanup Instructions
        if: steps.detect-trigger.outputs.trigger_type == 'tag_push'
        env:
          TAG_NAME: ${{ steps.detect-trigger.outputs.tag_name }}
        run: |
          echo "=== クリーンアップ手順 ==="
          echo "テスト完了後、以下のコマンドでテストタグを削除してください："
          echo ""
          echo "# ローカルでタグを削除"
          echo "git tag -d ${TAG_NAME}"
          echo ""
          echo "# リモートでタグを削除"
          echo "git push origin :refs/tags/${TAG_NAME}"
          echo ""
          echo "または GitHub Web UI から Releases ページでタグを削除できます"