name: test-pat-target
run-name: Test PAT Target Workflow

on:
  push:
    tags:
      - "test-v*.*.*" # test-v1.0.0 ã®ã‚ˆã†ãªãƒ†ã‚¹ãƒˆã‚¿ã‚°ã«ãƒãƒƒãƒ
      - "test-*"      # test- ã§å§‹ã¾ã‚‹ã™ã¹ã¦ã®ã‚¿ã‚°ã«ãƒãƒƒãƒ
  workflow_dispatch:
    inputs:
      test_tag:
        description: "æ‰‹å‹•å®Ÿè¡Œç”¨ã®ãƒ†ã‚¹ãƒˆã‚¿ã‚°å"
        required: false
        default: "manual-test"

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  test-pat-target-execution:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect Trigger Type
        id: detect-trigger
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "trigger_type=tag_push" >> $GITHUB_OUTPUT
            echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "trigger_type=manual" >> $GITHUB_OUTPUT
            echo "tag_name=${{ github.event.inputs.test_tag }}" >> $GITHUB_OUTPUT
          fi

      - name: PAT Test Result Verification
        env:
          TRIGGER_TYPE: ${{ steps.detect-trigger.outputs.trigger_type }}
          TAG_NAME: ${{ steps.detect-trigger.outputs.tag_name }}
        run: |
          echo "=== PATæ¨©é™ãƒ†ã‚¹ãƒˆçµæœ ==="
          echo "ãƒˆãƒªã‚¬ãƒ¼ã‚¿ã‚¤ãƒ—: ${TRIGGER_TYPE}"
          echo "å¯¾è±¡ã‚¿ã‚°: ${TAG_NAME}"
          echo "å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "GitHub Event: ${{ github.event_name }}"
          echo "GitHub Ref: ${{ github.ref }}"
          echo ""
          
          if [ "${TRIGGER_TYPE}" = "tag_push" ]; then
            echo "ğŸ‰ SUCCESS: PATæ¨©é™ã§ã®ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼èµ·å‹•ãŒæˆåŠŸã—ã¾ã—ãŸï¼"
            echo "âœ… test-pat-trigger ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‹ã‚‰ test-pat-target ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®é€£æºãŒæ­£å¸¸ã«å‹•ä½œ"
            echo "âœ… PAT_TOKEN ã‚’ä½¿ç”¨ã—ãŸGitHub Actionsé–“ã®é€£æºãŒæ©Ÿèƒ½ã™ã‚‹ã“ã¨ã‚’ç¢ºèª"
            echo ""
            echo "ğŸ“‹ ç¢ºèªã•ã‚ŒãŸæ©Ÿèƒ½:"
            echo "  - PAT_TOKEN ã«ã‚ˆã‚‹ã‚¿ã‚°ä½œæˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥"
            echo "  - ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥ã‚¤ãƒ™ãƒ³ãƒˆã«ã‚ˆã‚‹ä»–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®è‡ªå‹•èµ·å‹•"
            echo "  - GitHub Actionsé–“ã®é€£æºå‹•ä½œ"
          else
            echo "â„¹ï¸  INFO: æ‰‹å‹•å®Ÿè¡Œã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆã§ã™"
            echo "ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹è‡ªå‹•èµ·å‹•ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ test-pat-trigger ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
          fi

      - name: Test Environment Information
        run: |
          echo "=== ãƒ†ã‚¹ãƒˆç’°å¢ƒæƒ…å ± ==="
          echo "Runner OS: ${{ runner.os }}"
          echo "GitHub Repository: ${{ github.repository }}"
          echo "GitHub Actor: ${{ github.actor }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run Number: ${{ github.run_number }}"

      - name: Cleanup Instructions
        if: steps.detect-trigger.outputs.trigger_type == 'tag_push'
        env:
          TAG_NAME: ${{ steps.detect-trigger.outputs.tag_name }}
        run: |
          echo "=== ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ‰‹é † ==="
          echo "ãƒ†ã‚¹ãƒˆå®Œäº†å¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ†ã‚¹ãƒˆã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ï¼š"
          echo ""
          echo "# ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚¿ã‚°ã‚’å‰Šé™¤"
          echo "git tag -d ${TAG_NAME}"
          echo ""
          echo "# ãƒªãƒ¢ãƒ¼ãƒˆã§ã‚¿ã‚°ã‚’å‰Šé™¤"
          echo "git push origin :refs/tags/${TAG_NAME}"
          echo ""
          echo "ã¾ãŸã¯ GitHub Web UI ã‹ã‚‰ Releases ãƒšãƒ¼ã‚¸ã§ã‚¿ã‚°ã‚’å‰Šé™¤ã§ãã¾ã™"