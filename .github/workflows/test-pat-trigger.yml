name: test-pat-trigger
run-name: Test PAT Trigger Workflow

on:
  workflow_dispatch:
    inputs:
      test_tag:
        description: "テスト用タグ名 (例: test-v1.0.0)"
        required: true
        default: "test-v1.0.0"

permissions:
  contents: write

defaults:
  run:
    shell: bash

jobs:
  test-pat-tag-creation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Test Tag with PAT
        env:
          # Personal Access Tokenを使用してタグを作成
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          TEST_TAG: ${{ github.event.inputs.test_tag }}
        run: |
          echo "=== PAT権限テスト: タグ作成 ==="
          echo "作成するテストタグ: ${TEST_TAG}"
          
          # Gitユーザー設定
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Personal Access Tokenを使用してリモートURLを設定
          if [ -n "${GITHUB_TOKEN}" ]; then
            echo "PAT_TOKEN が設定されています"
            git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          else
            echo "❌ PAT_TOKEN が設定されていません"
            exit 1
          fi
          
          # テスト用タグを作成
          git tag "${TEST_TAG}"
          echo "タグ ${TEST_TAG} を作成しました"
          
          # タグをプッシュ（これによりtest-pat-targetワークフローが起動するかテスト）
          git push origin "${TEST_TAG}"
          echo "✅ タグ ${TEST_TAG} をプッシュしました"
          echo "test-pat-target ワークフローが起動するかを確認してください"

      - name: Test Result Summary
        run: |
          echo "=== テスト結果サマリー ==="
          echo "✅ PAT_TOKEN を使用してテストタグを作成・プッシュしました"
          echo "📋 次の確認事項："
          echo "  1. test-pat-target ワークフローが自動起動したか"
          echo "  2. タグプッシュイベントが正常に検知されたか"
          echo "  3. PAT権限でのワークフロー連携が機能するか"