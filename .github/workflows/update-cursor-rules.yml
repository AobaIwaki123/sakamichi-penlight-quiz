name: update-cursor-rules
run-name: Cursor Rules è‡ªå‹•æ›´æ–°

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: read

defaults:
  run:
    shell: bash

jobs:
  update-cursor-rules:
    # PRãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: PRæƒ…å ±ã®å–å¾—
        id: pr-info
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          LABELS="${{ join(github.event.pull_request.labels.*.name, ',') }}"
          MERGED_AT=$(date '+%Y-%m-%d %H:%M:%S')
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "labels=$LABELS" >> $GITHUB_OUTPUT
          echo "merged_at=$MERGED_AT" >> $GITHUB_OUTPUT
          
          echo "=== PRæƒ…å ± ==="
          echo "Number: $PR_NUMBER"
          echo "Title: $PR_TITLE"
          echo "Labels: $LABELS"
          echo "Merged at: $MERGED_AT"

      - name: å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†æ
        id: analyze-changes
        run: |
          echo "=== ãƒãƒ¼ã‚¸ã•ã‚ŒãŸå¤‰æ›´ã®åˆ†æ ==="
          
          # ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã‹ã‚‰å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD^2 HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # æ›´æ–°ãŒå¿…è¦ãªrulesãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰¹å®š
          RULES_TO_UPDATE=""
          
          # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–¢é€£
          if echo "$CHANGED_FILES" | grep -E '^view/(components|stores|hooks|types|app)/' > /dev/null; then
            RULES_TO_UPDATE="$RULES_TO_UPDATE frontend-architecture"
            echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ›´æ–°ãŒå¿…è¦"
          fi
          
          # API/BigQueryé–¢é€£
          if echo "$CHANGED_FILES" | grep -E '^view/api/|^definitions/' > /dev/null; then
            RULES_TO_UPDATE="$RULES_TO_UPDATE dataform-pipeline bigquery-integration"
            echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãƒ»BigQueryçµ±åˆã®æ›´æ–°ãŒå¿…è¦"
          fi
          
          # ã‚¤ãƒ³ãƒ•ãƒ©é–¢é€£
          if echo "$CHANGED_FILES" | grep -E '^k8s/|^\.github/workflows/|Dockerfile' > /dev/null; then
            RULES_TO_UPDATE="$RULES_TO_UPDATE deployment-infrastructure"
            echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ»ã‚¤ãƒ³ãƒ•ãƒ©ã®æ›´æ–°ãŒå¿…è¦"
          fi
          
          # ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„é–¢é€£ï¼ˆæ–°ã—ã„lintãƒ«ãƒ¼ãƒ«ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
          if echo "$CHANGED_FILES" | grep -E '\.(eslintrc|prettier|tsconfig)' > /dev/null; then
            RULES_TO_UPDATE="$RULES_TO_UPDATE coding-standards"
            echo "âœ… ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã®æ›´æ–°ãŒå¿…è¦"
          fi
          
          echo "rules_to_update=$RULES_TO_UPDATE" >> $GITHUB_OUTPUT

      - name: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦ã®æ›´æ–°
        if: contains(github.event.pull_request.labels.*.name, 'minor') || contains(github.event.pull_request.labels.*.name, 'major')
        run: |
          RULES_FILE=".cursor/rules/project-overview.mdc"
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"
          PR_TITLE="${{ steps.pr-info.outputs.pr_title }}"
          MERGED_AT="${{ steps.pr-info.outputs.merged_at }}"
          LABELS="${{ steps.pr-info.outputs.labels }}"
          
          echo "" >> "$RULES_FILE"
          echo "## æ›´æ–°å±¥æ­´" >> "$RULES_FILE"
          echo "" >> "$RULES_FILE"
          echo "### $MERGED_AT - PR #$PR_NUMBER" >> "$RULES_FILE"
          echo "- **å¤‰æ›´å†…å®¹**: $PR_TITLE" >> "$RULES_FILE"
          echo "- **å½±éŸ¿åº¦**: $LABELS" >> "$RULES_FILE"
          echo "" >> "$RULES_FILE"
          
          echo "âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦ã‚’æ›´æ–°ã—ã¾ã—ãŸ"

      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ›´æ–°
        if: contains(steps.analyze-changes.outputs.rules_to_update, 'frontend-architecture')
        run: |
          RULES_FILE=".cursor/rules/frontend-architecture.mdc"
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"
          MERGED_AT="${{ steps.pr-info.outputs.merged_at }}"
          
          # ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          COMPONENT_COUNT=$(find view/components -name "*.tsx" | wc -l)
          STORE_COUNT=$(find view/stores -name "*.ts" | wc -l)
          HOOK_COUNT=$(find view/hooks -name "*.tsx" | wc -l)
          
          # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
          echo "" >> "$RULES_FILE"
          echo "## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ±è¨ˆ (æœ€çµ‚æ›´æ–°: $MERGED_AT)" >> "$RULES_FILE"
          echo "" >> "$RULES_FILE"
          echo "- Reactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ•°: $COMPONENT_COUNT" >> "$RULES_FILE"
          echo "- Zustandã‚¹ãƒˆã‚¢æ•°: $STORE_COUNT" >> "$RULES_FILE"
          echo "- ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯æ•°: $HOOK_COUNT" >> "$RULES_FILE"
          echo "- æœ€çµ‚æ›´æ–°PR: #$PR_NUMBER" >> "$RULES_FILE"
          
          echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ"

      - name: ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­å®šã®æ›´æ–°
        if: contains(steps.analyze-changes.outputs.rules_to_update, 'dataform-pipeline')
        run: |
          RULES_FILE=".cursor/rules/dataform-pipeline.mdc"
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"
          MERGED_AT="${{ steps.pr-info.outputs.merged_at }}"
          
          # SQLãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          SQL_COUNT=$(find definitions -name "*.sqlx" | wc -l)
          
          echo "" >> "$RULES_FILE"
          echo "## ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çµ±è¨ˆ (æœ€çµ‚æ›´æ–°: $MERGED_AT)" >> "$RULES_FILE"
          echo "" >> "$RULES_FILE"
          echo "- Dataform SQLãƒ•ã‚¡ã‚¤ãƒ«æ•°: $SQL_COUNT" >> "$RULES_FILE"
          echo "- æœ€çµ‚æ›´æ–°PR: #$PR_NUMBER" >> "$RULES_FILE"
          
          echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ"

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨­å®šã®æ›´æ–°
        if: contains(steps.analyze-changes.outputs.rules_to_update, 'deployment-infrastructure')
        run: |
          RULES_FILE=".cursor/rules/deployment-infrastructure.mdc"
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"
          MERGED_AT="${{ steps.pr-info.outputs.merged_at }}"
          
          echo "" >> "$RULES_FILE"
          echo "## ã‚¤ãƒ³ãƒ•ãƒ©æ›´æ–°å±¥æ­´ (æœ€çµ‚æ›´æ–°: $MERGED_AT)" >> "$RULES_FILE"
          echo "" >> "$RULES_FILE"
          echo "- PR #$PR_NUMBER ã«ã‚ˆã‚‹è¨­å®šæ›´æ–°" >> "$RULES_FILE"
          
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ"

      - name: æœ€çµ‚æ›´æ–°æ™‚åˆ»ã®è¨˜éŒ²
        run: |
          TIMESTAMP="${{ steps.pr-info.outputs.merged_at }}"
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"
          
          echo "æœ€çµ‚æ›´æ–°: $TIMESTAMP" > .cursor/rules/.last-update
          echo "æ›´æ–°PR: #$PR_NUMBER" >> .cursor/rules/.last-update
          
          echo "âœ… æ›´æ–°æ™‚åˆ»ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ"

      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
        run: |
          # Gitè¨­å®š
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --quiet .cursor/rules/; then
            echo "ğŸ“ Cursor Rulesã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            exit 0
          fi
          
          # å¤‰æ›´å†…å®¹ã‚’è¡¨ç¤º
          echo "=== Cursor Rules ã®å¤‰æ›´å†…å®¹ ==="
          git diff .cursor/rules/
          
          # ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
          git add .cursor/rules/
          git commit -m "auto: Cursor Rulesæ›´æ–° (PR #${{ steps.pr-info.outputs.pr_number }})"
          git push
          
          echo "âœ… Cursor Rulesã®æ›´æ–°ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"

      - name: æ›´æ–°å®Œäº†ã®é€šçŸ¥
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            
            const comment = `## ğŸ”„ Cursor Rules è‡ªå‹•æ›´æ–°å®Œäº†\n\n` +
              `PR #${pull_number} ã®ãƒãƒ¼ã‚¸ã«ä¼´ã„ã€Cursor RulesãŒè‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚\n\n` +
              `### æ›´æ–°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«\n` +
              `${{ steps.analyze-changes.outputs.rules_to_update }}\n\n` +
              `### è©³ç´°\n` +
              `- æ›´æ–°æ—¥æ™‚: ${{ steps.pr-info.outputs.merged_at }}\n` +
              `- å¤‰æ›´ãƒ©ãƒ™ãƒ«: ${{ steps.pr-info.outputs.labels }}\n\n` +
              `---\n` +
              `*ã“ã®æ›´æ–°ã¯è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚å¤‰æ›´å†…å®¹ã¯ [ã“ã¡ã‚‰](https://github.com/${owner}/${repo}/tree/main/.cursor/rules) ã§ç¢ºèªã§ãã¾ã™ã€‚*`;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pull_number,
              body: comment
            });