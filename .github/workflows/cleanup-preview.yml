name: Cleanup Preview Environment
run-name: Cleanup preview for ${{ github.event.ref || github.event.pull_request.head.ref }}

on:
  pull_request:
    types: [closed]
  delete:
    # ãƒ–ãƒ©ãƒ³ãƒå‰Šé™¤æ™‚ã«å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      service_name:
        description: "å‰Šé™¤ã™ã‚‹Cloud Runã‚µãƒ¼ãƒ“ã‚¹åï¼ˆä¾‹: penlight-pr-123, penlight-feature-testï¼‰"
        required: true
        type: string
      force_delete:
        description: "å¼·åˆ¶å‰Šé™¤ï¼ˆç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰"
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  id-token: write
  pull-requests: write

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: asia-northeast1

defaults:
  run:
    shell: bash

jobs:
  # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¯¾è±¡ã®ç‰¹å®š
  identify-services:
    runs-on: ubuntu-latest
    outputs:
      services_to_delete: ${{ steps.identify.outputs.services }}
      has_services: ${{ steps.identify.outputs.has_services }}
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Identify services to delete
        id: identify
        run: |
          SERVICES_JSON="[]"
          HAS_SERVICES="false"
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã¯æŒ‡å®šã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹åã‚’ä½¿ç”¨
            SERVICE_NAME="${{ github.event.inputs.service_name }}"
            echo "ğŸ¯ æ‰‹å‹•æŒ‡å®šã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹: ${SERVICE_NAME}"
            
            # ã‚µãƒ¼ãƒ“ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if gcloud run services describe "${SERVICE_NAME}" \
                --region="${{ env.GCP_REGION }}" \
                --format="value(metadata.name)" \
                --quiet >/dev/null 2>&1; then
              SERVICES_JSON="[\"${SERVICE_NAME}\"]"
              HAS_SERVICES="true"
              echo "âœ… ã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: ${SERVICE_NAME}"
            else
              echo "âš ï¸ ã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${SERVICE_NAME}"
            fi
            
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            # PR ã‚¯ãƒ­ãƒ¼ã‚ºæ™‚
            PR_NUMBER="${{ github.event.number }}"
            SERVICE_NAME="penlight-pr-${PR_NUMBER}"
            echo "ğŸ” PR #${PR_NUMBER} ã«é–¢é€£ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç¢ºèªä¸­..."
            
            if gcloud run services describe "${SERVICE_NAME}" \
                --region="${{ env.GCP_REGION }}" \
                --format="value(metadata.name)" \
                --quiet >/dev/null 2>&1; then
              SERVICES_JSON="[\"${SERVICE_NAME}\"]"
              HAS_SERVICES="true"
              echo "âœ… PRé–¢é€£ã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: ${SERVICE_NAME}"
            else
              echo "â„¹ï¸ PRé–¢é€£ã‚µãƒ¼ãƒ“ã‚¹ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            fi
            
          elif [ "${{ github.event_name }}" = "delete" ]; then
            # ãƒ–ãƒ©ãƒ³ãƒå‰Šé™¤æ™‚
            DELETED_REF="${{ github.event.ref }}"
            echo "ğŸ” å‰Šé™¤ã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒ: ${DELETED_REF}"
            
            # ãƒ–ãƒ©ãƒ³ãƒåã‚’ã‚µãƒ¼ãƒ“ã‚¹åã«å¤‰æ›
            SAFE_BRANCH=$(echo "$DELETED_REF" | \
              sed 's/[^a-zA-Z0-9-]/-/g' | \
              sed 's/--*/-/g' | \
              sed 's/^-\|-$//g' | \
              tr '[:upper:]' '[:lower:]' | \
              cut -c1-50)
            SERVICE_NAME="penlight-${SAFE_BRANCH}"
            
            echo "ğŸ¯ æ¨å®šã‚µãƒ¼ãƒ“ã‚¹å: ${SERVICE_NAME}"
            
            if gcloud run services describe "${SERVICE_NAME}" \
                --region="${{ env.GCP_REGION }}" \
                --format="value(metadata.name)" \
                --quiet >/dev/null 2>&1; then
              SERVICES_JSON="[\"${SERVICE_NAME}\"]"
              HAS_SERVICES="true"
              echo "âœ… ãƒ–ãƒ©ãƒ³ãƒé–¢é€£ã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: ${SERVICE_NAME}"
            else
              echo "â„¹ï¸ ãƒ–ãƒ©ãƒ³ãƒé–¢é€£ã‚µãƒ¼ãƒ“ã‚¹ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            fi
          fi
          
          echo "services=${SERVICES_JSON}" >> $GITHUB_OUTPUT
          echo "has_services=${HAS_SERVICES}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ å‰Šé™¤å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹: ${SERVICES_JSON}"

  # Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã®å‰Šé™¤
  delete-services:
    runs-on: ubuntu-latest
    needs: identify-services
    if: needs.identify-services.outputs.has_services == 'true'
    strategy:
      matrix:
        service: ${{ fromJson(needs.identify-services.outputs.services_to_delete) }}
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Delete Cloud Run service
        run: |
          SERVICE_NAME="${{ matrix.service }}"
          
          echo "ğŸ—‘ï¸ Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã‚’å‰Šé™¤ä¸­: ${SERVICE_NAME}"
          
          # ã‚µãƒ¼ãƒ“ã‚¹ã®è©³ç´°æƒ…å ±ã‚’å–å¾—ï¼ˆå‰Šé™¤å‰ï¼‰
          echo "ğŸ“‹ å‰Šé™¤å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹ã®æƒ…å ±:"
          gcloud run services describe "${SERVICE_NAME}" \
            --region="${{ env.GCP_REGION }}" \
            --format="table(
              metadata.name:label=SERVICE_NAME,
              spec.template.spec.containers[0].image:label=IMAGE,
              metadata.labels.branch:label=BRANCH,
              metadata.labels.type:label=TYPE,
              metadata.creationTimestamp:label=CREATED
            )" || echo "âš ï¸ ã‚µãƒ¼ãƒ“ã‚¹è©³ç´°ã®å–å¾—ã«å¤±æ•—"
          
          # ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‰Šé™¤
          if gcloud run services delete "${SERVICE_NAME}" \
              --region="${{ env.GCP_REGION }}" \
              --quiet; then
            echo "âœ… ã‚µãƒ¼ãƒ“ã‚¹å‰Šé™¤å®Œäº†: ${SERVICE_NAME}"
          else
            echo "âŒ ã‚µãƒ¼ãƒ“ã‚¹å‰Šé™¤ã«å¤±æ•—: ${SERVICE_NAME}"
            exit 1
          fi

  # é–¢é€£ã™ã‚‹Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®å‰Šé™¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  cleanup-images:
    runs-on: ubuntu-latest
    needs: [identify-services, delete-services]
    if: needs.identify-services.outputs.has_services == 'true'
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Cleanup old preview images
        run: |
          echo "ğŸ§¹ å¤ã„ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
          
          # 30æ—¥ä»¥ä¸Šå¤ã„ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤
          CUTOFF_DATE=$(date -d '30 days ago' -u +%Y-%m-%dT%H:%M:%S)
          
          # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒªã‚¹ãƒˆã‚’å–å¾—
          IMAGES=$(gcloud container images list-tags \
            "gcr.io/${{ env.GCP_PROJECT_ID }}/penlight-preview" \
            --format="value(digest,timestamp.datetime)" \
            --filter="timestamp.datetime < '${CUTOFF_DATE}'" \
            --limit=50 2>/dev/null || echo "")
          
          if [ -z "$IMAGES" ]; then
            echo "â„¹ï¸ å‰Šé™¤å¯¾è±¡ã®å¤ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“"
            exit 0
          fi
          
          echo "ğŸ“‹ å‰Šé™¤å¯¾è±¡ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆ30æ—¥ä»¥ä¸Šå‰ï¼‰:"
          echo "$IMAGES"
          
          # ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤
          echo "$IMAGES" | while read -r digest timestamp; do
            if [ -n "$digest" ]; then
              echo "ğŸ—‘ï¸ ã‚¤ãƒ¡ãƒ¼ã‚¸å‰Šé™¤ä¸­: $digest ($timestamp)"
              gcloud container images delete \
                "gcr.io/${{ env.GCP_PROJECT_ID }}/penlight-preview@$digest" \
                --quiet || echo "âš ï¸ ã‚¤ãƒ¡ãƒ¼ã‚¸å‰Šé™¤ã«å¤±æ•—: $digest"
            fi
          done
          
          echo "âœ… ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

  # PRã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†ã‚’ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆPRã‚¯ãƒ­ãƒ¼ã‚ºæ™‚ã®ã¿ï¼‰
  comment-cleanup:
    runs-on: ubuntu-latest
    needs: [identify-services, delete-services]
    if: github.event_name == 'pull_request' && needs.identify-services.outputs.has_services == 'true'
    steps:
      - name: Comment cleanup on PR
        uses: actions/github-script@v7
        with:
          script: |
            const services = ${{ needs.identify-services.outputs.services_to_delete }};
            const serviceList = services.map(s => `- \`${s}\``).join('\n');
            
            const body = `## ğŸ§¹ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†
            
            PRã®ã‚¯ãƒ­ãƒ¼ã‚ºã«ä¼´ã„ã€ä»¥ä¸‹ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼š
            
            ${serviceList}
            
            ### ğŸ“‹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å†…å®¹
            - âœ… Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã®å‰Šé™¤
            - âœ… é–¢é€£ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤
            - ğŸ§¹ å¤ã„Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®å‰Šé™¤ï¼ˆ30æ—¥ä»¥ä¸Šå‰ï¼‰
            
            ---
            *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—çµæœã®é€šçŸ¥
  notify-cleanup-result:
    runs-on: ubuntu-latest
    needs: [identify-services, delete-services]
    if: always()
    steps:
      - name: Notify cleanup result
        run: |
          if [ "${{ needs.identify-services.outputs.has_services }}" = "false" ]; then
            echo "â„¹ï¸ å‰Šé™¤å¯¾è±¡ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          elif [ "${{ needs.delete-services.result }}" = "success" ]; then
            echo "âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"
            SERVICES='${{ needs.identify-services.outputs.services_to_delete }}'
            echo "ğŸ—‘ï¸ å‰Šé™¤ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹: ${SERVICES}"
          else
            echo "âŒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi