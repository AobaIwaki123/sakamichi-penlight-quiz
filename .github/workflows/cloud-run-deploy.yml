name: cloud-run-deploy
run-name: Cloud Run ãƒ‡ãƒ—ãƒ­ã‚¤ - ${{ github.ref_name }}

# ãƒ–ãƒ©ãƒ³ãƒã”ã¨ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨­å®š
on:
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      branch:
        description: "ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒå"
        required: true
        default: "main"
      force_deploy:
        description: "å¼·åˆ¶ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä¸Šæ›¸ãï¼‰"
        type: boolean
        default: false
  
  # ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
  push:
    branches:
      - main
      - develop
      - "feature/**"
      - "fix/**"
      - "hotfix/**"
  
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒ
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  id-token: write  # Workload Identityç”¨

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: asia-northeast1  # Artifact Registry ã®å ´æ‰€
  GAR_REPOSITORY: penlight       # Artifact Registry ãƒªãƒã‚¸ãƒˆãƒªå
  SERVICE_NAME_PREFIX: penlight  # Cloud Run ã‚µãƒ¼ãƒ“ã‚¹åã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
  REGION: asia-northeast1        # Cloud Run ãƒªãƒ¼ã‚¸ãƒ§ãƒ³

defaults:
  run:
    shell: bash

jobs:
  # ç’°å¢ƒè¨­å®šã¨ã‚µãƒ¼ãƒ“ã‚¹åã®æ±ºå®š
  setup:
    runs-on: ubuntu-latest
    outputs:
      service_name: ${{ steps.service-config.outputs.service_name }}
      image_tag: ${{ steps.service-config.outputs.image_tag }}
      environment: ${{ steps.service-config.outputs.environment }}
      should_deploy: ${{ steps.service-config.outputs.should_deploy }}
      cleanup_required: ${{ steps.service-config.outputs.cleanup_required }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ã‚µãƒ¼ãƒ“ã‚¹è¨­å®šã®æ±ºå®š
        id: service-config
        run: |
          # ãƒ–ãƒ©ãƒ³ãƒåã®æ­£è¦åŒ–ï¼ˆCloud Runã‚µãƒ¼ãƒ“ã‚¹åã«ä½¿ç”¨å¯èƒ½ãªå½¢å¼ã«å¤‰æ›ï¼‰
          BRANCH_NAME="${{ github.event.inputs.branch || github.ref_name }}"
          NORMALIZED_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-z0-9-]/-/g' | tr '[:upper:]' '[:lower:]' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
          
          # ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«ã‚ˆã‚‹å‡¦ç†åˆ†å²
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # PRç’°å¢ƒ: pr-{ç•ªå·} å½¢å¼
            SERVICE_NAME="${SERVICE_NAME_PREFIX}-pr-${{ github.event.number }}"
            IMAGE_TAG="pr-${{ github.event.number }}-$(git rev-parse --short HEAD)"
            ENVIRONMENT="preview"
            SHOULD_DEPLOY="true"
            CLEANUP_REQUIRED="false"
            
          elif [[ "$NORMALIZED_BRANCH" == "main" ]]; then
            # æœ¬ç•ªç’°å¢ƒ
            SERVICE_NAME="${SERVICE_NAME_PREFIX}-prod"
            IMAGE_TAG="prod-$(git rev-parse --short HEAD)"
            ENVIRONMENT="production"
            SHOULD_DEPLOY="true"
            CLEANUP_REQUIRED="false"
            
          elif [[ "$NORMALIZED_BRANCH" == "develop" ]]; then
            # é–‹ç™ºç’°å¢ƒ
            SERVICE_NAME="${SERVICE_NAME_PREFIX}-dev"
            IMAGE_TAG="dev-$(git rev-parse --short HEAD)"
            ENVIRONMENT="development"
            SHOULD_DEPLOY="true"
            CLEANUP_REQUIRED="false"
            
          else
            # ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ–ãƒ©ãƒ³ãƒç’°å¢ƒ
            SERVICE_NAME="${SERVICE_NAME_PREFIX}-${NORMALIZED_BRANCH}"
            IMAGE_TAG="${NORMALIZED_BRANCH}-$(git rev-parse --short HEAD)"
            ENVIRONMENT="feature"
            SHOULD_DEPLOY="true"
            CLEANUP_REQUIRED="true"  # ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ–ãƒ©ãƒ³ãƒã¯å¾Œã§ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          fi
          
          # ã‚µãƒ¼ãƒ“ã‚¹åã®é•·ã•åˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆCloud Runã¯63æ–‡å­—ã¾ã§ï¼‰
          if [[ ${#SERVICE_NAME} -gt 63 ]]; then
            # é•·ã™ãã‚‹å ´åˆã¯ãƒãƒƒã‚·ãƒ¥ã§çŸ­ç¸®
            HASH=$(echo "$SERVICE_NAME" | sha256sum | cut -c1-8)
            SERVICE_NAME="${SERVICE_NAME_PREFIX}-${HASH}"
          fi
          
          echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "cleanup_required=$CLEANUP_REQUIRED" >> $GITHUB_OUTPUT
          
          echo "ğŸ·ï¸ ã‚µãƒ¼ãƒ“ã‚¹å: $SERVICE_NAME"
          echo "ğŸ·ï¸ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°: $IMAGE_TAG"
          echo "ğŸ·ï¸ ç’°å¢ƒ: $ENVIRONMENT"

  # Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ—ãƒƒã‚·ãƒ¥
  build-and-push:
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should_deploy == 'true'
    outputs:
      image_url: ${{ steps.build-image.outputs.image_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Google Cloud èªè¨¼
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Cloud SDK ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: google-github-actions/setup-gcloud@v2

      - name: Docker èªè¨¼è¨­å®š
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev --quiet

      - name: Docker Buildx ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: docker/setup-buildx-action@v3

      - name: Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ—ãƒƒã‚·ãƒ¥
        id: build-image
        run: |
          IMAGE_URL="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ needs.setup.outputs.service_name }}:${{ needs.setup.outputs.image_tag }}"
          
          echo "ğŸ—ï¸ ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰é–‹å§‹: $IMAGE_URL"
          
          docker build \
            --target prod \
            --platform linux/amd64 \
            --tag "$IMAGE_URL" \
            --file ./view/Dockerfile \
            ./view
          
          echo "ğŸ“¦ ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ—ãƒƒã‚·ãƒ¥é–‹å§‹"
          docker push "$IMAGE_URL"
          
          echo "image_url=$IMAGE_URL" >> $GITHUB_OUTPUT
          echo "âœ… ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†: $IMAGE_URL"

  # Cloud Run ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy:
    runs-on: ubuntu-latest
    needs: [setup, build-and-push]
    if: needs.setup.outputs.should_deploy == 'true'
    outputs:
      service_url: ${{ steps.deploy-service.outputs.service_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Google Cloud èªè¨¼
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Cloud SDK ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: google-github-actions/setup-gcloud@v2

      - name: Cloud Run ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deploy-service
        run: |
          SERVICE_NAME="${{ needs.setup.outputs.service_name }}"
          IMAGE_URL="${{ needs.build-and-push.outputs.image_url }}"
          ENVIRONMENT="${{ needs.setup.outputs.environment }}"
          
          echo "ğŸš€ Cloud Run ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹"
          echo "ã‚µãƒ¼ãƒ“ã‚¹å: $SERVICE_NAME"
          echo "ã‚¤ãƒ¡ãƒ¼ã‚¸: $IMAGE_URL"
          echo "ç’°å¢ƒ: $ENVIRONMENT"
          
          # ç’°å¢ƒåˆ¥ã®è¨­å®š
          case "$ENVIRONMENT" in
            "production")
              MAX_INSTANCES=10
              MIN_INSTANCES=1
              CPU_LIMIT="2"
              MEMORY_LIMIT="2Gi"
              CONCURRENCY=100
              ;;
            "development")
              MAX_INSTANCES=5
              MIN_INSTANCES=0
              CPU_LIMIT="1"
              MEMORY_LIMIT="1Gi"
              CONCURRENCY=50
              ;;
            "preview"|"feature")
              MAX_INSTANCES=2
              MIN_INSTANCES=0
              CPU_LIMIT="1"
              MEMORY_LIMIT="512Mi"
              CONCURRENCY=20
              ;;
          esac
          
          # Cloud Run ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
          gcloud run deploy "$SERVICE_NAME" \
            --image="$IMAGE_URL" \
            --region="${{ env.REGION }}" \
            --platform=managed \
            --allow-unauthenticated \
            --port=3000 \
            --max-instances="$MAX_INSTANCES" \
            --min-instances="$MIN_INSTANCES" \
            --cpu="$CPU_LIMIT" \
            --memory="$MEMORY_LIMIT" \
            --concurrency="$CONCURRENCY" \
            --timeout=300s \
            --execution-environment=gen2 \
            --service-account="${{ secrets.CLOUD_RUN_SA_EMAIL }}" \
            --set-env-vars="NODE_ENV=production" \
            --set-env-vars="GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json" \
            --set-secrets="GCP_SA_KEY=projects/${{ env.PROJECT_ID }}/secrets/bigquery-sa-key:latest" \
            --labels="environment=$ENVIRONMENT,branch=${{ github.ref_name }},commit=${{ github.sha }}" \
            --revision-suffix="$(date +%Y%m%d-%H%M%S)" \
            --quiet
          
          # ã‚µãƒ¼ãƒ“ã‚¹URLã®å–å¾—
          SERVICE_URL=$(gcloud run services describe "$SERVICE_NAME" \
            --region="${{ env.REGION }}" \
            --format="value(status.url)")
          
          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†: $SERVICE_URL"

  # ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã®é€šçŸ¥ã¨ã‚³ãƒ¡ãƒ³ãƒˆ
  notify:
    runs-on: ubuntu-latest
    needs: [setup, deploy]
    if: always() && needs.setup.outputs.should_deploy == 'true'
    steps:
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã®é€šçŸ¥
        run: |
          SERVICE_NAME="${{ needs.setup.outputs.service_name }}"
          SERVICE_URL="${{ needs.deploy.outputs.service_url }}"
          ENVIRONMENT="${{ needs.setup.outputs.environment }}"
          
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸï¼"
            echo "ğŸŒ ã‚µãƒ¼ãƒ“ã‚¹URL: $SERVICE_URL"
            echo "ğŸ·ï¸ ã‚µãƒ¼ãƒ“ã‚¹å: $SERVICE_NAME"
            echo "ğŸ·ï¸ ç’°å¢ƒ: $ENVIRONMENT"
            
            # PRç’°å¢ƒã®å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
            if [[ "${{ github.event_name }}" == "pull_request" ]]; then
              # PRã‚³ãƒ¡ãƒ³ãƒˆç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆï¼ˆåˆ¥ã®ã‚¸ãƒ§ãƒ–ã§å‡¦ç†ï¼‰
              echo "PR_COMMENT_NEEDED=true" >> $GITHUB_ENV
            fi
          else
            echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—"
            exit 1
          fi

      - name: PR ã‚³ãƒ¡ãƒ³ãƒˆã®è¿½åŠ 
        if: github.event_name == 'pull_request' && needs.deploy.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const serviceUrl = '${{ needs.deploy.outputs.service_url }}';
            const serviceName = '${{ needs.setup.outputs.service_name }}';
            const environment = '${{ needs.setup.outputs.environment }}';
            
            const comment = `## ğŸš€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
            
            **ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±:**
            - ğŸŒ **URL**: ${serviceUrl}
            - ğŸ·ï¸ **ã‚µãƒ¼ãƒ“ã‚¹å**: \`${serviceName}\`
            - ğŸ·ï¸ **ç’°å¢ƒ**: ${environment}
            - ğŸ·ï¸ **ã‚³ãƒŸãƒƒãƒˆ**: ${context.sha.substring(0, 8)}
            
            **åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½:**
            - ğŸ“± ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–æ¸ˆã¿
            - ğŸ¯ æ—¥å‘å‚46ãƒšãƒ³ãƒ©ã‚¤ãƒˆã‚¯ã‚¤ã‚º
            - ğŸ”„ BigQueryãƒ‡ãƒ¼ã‚¿é€£æº
            
            **æ³¨æ„äº‹é …:**
            - ã“ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã¯PRã‚¯ãƒ­ãƒ¼ã‚ºæ™‚ã«è‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™
            - æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€é©åˆ‡ã«ã”åˆ©ç”¨ãã ã•ã„
            
            ---
            *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # PR ã‚¯ãƒ­ãƒ¼ã‚ºæ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  cleanup:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    steps:
      - name: Google Cloud èªè¨¼
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Cloud SDK ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: google-github-actions/setup-gcloud@v2

      - name: PRç’°å¢ƒã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        run: |
          SERVICE_NAME="${{ env.SERVICE_NAME_PREFIX }}-pr-${{ github.event.number }}"
          
          echo "ğŸ§¹ PRç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹: $SERVICE_NAME"
          
          # Cloud Run ã‚µãƒ¼ãƒ“ã‚¹ã®å‰Šé™¤
          if gcloud run services describe "$SERVICE_NAME" --region="${{ env.REGION }}" >/dev/null 2>&1; then
            echo "ğŸ—‘ï¸ Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã‚’å‰Šé™¤ä¸­..."
            gcloud run services delete "$SERVICE_NAME" \
              --region="${{ env.REGION }}" \
              --quiet
            echo "âœ… ã‚µãƒ¼ãƒ“ã‚¹å‰Šé™¤å®Œäº†: $SERVICE_NAME"
          else
            echo "â„¹ï¸ ã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ—¢ã«å‰Šé™¤æ¸ˆã¿ï¼‰: $SERVICE_NAME"
          fi
          
          # Artifact Registry ã‚¤ãƒ¡ãƒ¼ã‚¸ã®å‰Šé™¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          echo "ğŸ§¹ å¤ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
          gcloud artifacts docker images list \
            "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}" \
            --filter="tags:pr-${{ github.event.number }}-*" \
            --format="value(IMAGE_URI)" | \
          while read -r image; do
            if [[ -n "$image" ]]; then
              echo "ğŸ—‘ï¸ ã‚¤ãƒ¡ãƒ¼ã‚¸å‰Šé™¤: $image"
              gcloud artifacts docker images delete "$image" --quiet || true
            fi
          done
          
          echo "âœ… PRç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

      - name: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—çµæœã®é€šçŸ¥
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ğŸ§¹ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†
            
            PR #${{ github.event.number }} ã«é–¢é€£ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼š
            
            - ğŸ—‘ï¸ Cloud Run ã‚µãƒ¼ãƒ“ã‚¹: \`${{ env.SERVICE_NAME_PREFIX }}-pr-${{ github.event.number }}\`
            - ğŸ—‘ï¸ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆé–¢é€£ã™ã‚‹ã‚‚ã®ï¼‰
            
            ---
            *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });