name: Branch Preview Environment
run-name: Deploy preview for ${{ github.ref_name }}

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'view/**'
      - '.github/workflows/branch-preview.yml'
  push:
    branches:
      - 'feature/**'
      - 'fix/**'
      - 'refactor/**'
      - 'develop'
    paths:
      - 'view/**'
      - '.github/workflows/branch-preview.yml'

permissions:
  contents: read
  id-token: write
  pull-requests: write

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: asia-northeast1
  SERVICE_NAME_PREFIX: penlight-preview
  
defaults:
  run:
    shell: bash

jobs:
  # ãƒ–ãƒ©ãƒ³ãƒåã‚’å®‰å…¨ãªå½¢å¼ã«å¤‰æ›
  prepare:
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.branch.outputs.name }}
      service_name: ${{ steps.branch.outputs.service_name }}
      image_tag: ${{ steps.branch.outputs.image_tag }}
      is_pr: ${{ steps.branch.outputs.is_pr }}
    steps:
      - name: Extract branch information
        id: branch
        run: |
          # ãƒ–ãƒ©ãƒ³ãƒåã®å–å¾—ï¼ˆPR ã®å ´åˆã¯ head_ref ã‚’ä½¿ç”¨ï¼‰
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH_NAME="${{ github.head_ref }}"
            IS_PR="true"
            PR_NUMBER="${{ github.event.number }}"
          else
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
            IS_PR="false"
            PR_NUMBER=""
          fi
          
          # ãƒ–ãƒ©ãƒ³ãƒåã‚’Cloud Run ã‚µãƒ¼ãƒ“ã‚¹åã¨ã—ã¦æœ‰åŠ¹ãªå½¢å¼ã«å¤‰æ›
          # - è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿è¨±å¯
          # - æœ€å¤§63æ–‡å­—
          # - å…ˆé ­ã¨æœ«å°¾ã¯è‹±æ•°å­—
          SAFE_BRANCH=$(echo "$BRANCH_NAME" | \
            sed 's/[^a-zA-Z0-9-]/-/g' | \
            sed 's/--*/-/g' | \
            sed 's/^-\|-$//g' | \
            tr '[:upper:]' '[:lower:]' | \
            cut -c1-50)
          
          # PRç•ªå·ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
          if [ -n "$PR_NUMBER" ]; then
            SERVICE_NAME="penlight-pr-${PR_NUMBER}"
            IMAGE_TAG="pr-${PR_NUMBER}-$(echo ${{ github.sha }} | cut -c1-8)"
          else
            SERVICE_NAME="penlight-${SAFE_BRANCH}"
            IMAGE_TAG="${SAFE_BRANCH}-$(echo ${{ github.sha }} | cut -c1-8)"
          fi
          
          echo "name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "service_name=${SERVICE_NAME}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "is_pr=${IS_PR}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±:"
          echo "  - ãƒ–ãƒ©ãƒ³ãƒå: ${BRANCH_NAME}"
          echo "  - ã‚µãƒ¼ãƒ“ã‚¹å: ${SERVICE_NAME}"
          echo "  - ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°: ${IMAGE_TAG}"
          echo "  - PR: ${IS_PR}"

  # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ—ãƒƒã‚·ãƒ¥
  build-and-push:
    runs-on: ubuntu-latest
    needs: prepare
    outputs:
      image_url: ${{ steps.image.outputs.url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        id: image
        run: |
          IMAGE_URL="gcr.io/${{ env.GCP_PROJECT_ID }}/penlight-preview:${{ needs.prepare.outputs.image_tag }}"
          
          echo "ğŸ—ï¸ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
          docker build \
            --target prod \
            --tag "${IMAGE_URL}" \
            ./view
          
          echo "ğŸ“¦ GCRã«ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."
          docker push "${IMAGE_URL}"
          
          echo "url=${IMAGE_URL}" >> $GITHUB_OUTPUT
          echo "âœ… ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†: ${IMAGE_URL}"

  # Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-to-cloud-run:
    runs-on: ubuntu-latest
    needs: [prepare, build-and-push]
    outputs:
      service_url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          SERVICE_NAME="${{ needs.prepare.outputs.service_name }}"
          IMAGE_URL="${{ needs.build-and-push.outputs.image_url }}"
          
          echo "ğŸš€ Cloud Runã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
          echo "  - ã‚µãƒ¼ãƒ“ã‚¹å: ${SERVICE_NAME}"
          echo "  - ã‚¤ãƒ¡ãƒ¼ã‚¸: ${IMAGE_URL}"
          echo "  - ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: ${{ env.GCP_REGION }}"
          
          # Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
          gcloud run deploy "${SERVICE_NAME}" \
            --image="${IMAGE_URL}" \
            --region="${{ env.GCP_REGION }}" \
            --platform=managed \
            --allow-unauthenticated \
            --port=3000 \
            --memory=1Gi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=2 \
            --timeout=300s \
            --concurrency=100 \
            --set-env-vars="NODE_ENV=development,USE_MOCK=true" \
            --labels="environment=preview,branch=${{ needs.prepare.outputs.branch_name }},type=preview" \
            --tag="${{ needs.prepare.outputs.image_tag }}" \
            --quiet
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã®URLã‚’å–å¾—
          SERVICE_URL=$(gcloud run services describe "${SERVICE_NAME}" \
            --region="${{ env.GCP_REGION }}" \
            --format="value(status.url)")
          
          echo "url=${SERVICE_URL}" >> $GITHUB_OUTPUT
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†: ${SERVICE_URL}"

  # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆPRã®å ´åˆã®ã¿ï¼‰
  comment-on-pr:
    runs-on: ubuntu-latest
    needs: [prepare, deploy-to-cloud-run]
    if: needs.prepare.outputs.is_pr == 'true'
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const serviceUrl = '${{ needs.deploy-to-cloud-run.outputs.service_url }}';
            const serviceName = '${{ needs.prepare.outputs.service_name }}';
            const imageTag = '${{ needs.prepare.outputs.image_tag }}';
            
            const body = `## ğŸš€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
            
            **ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URL**: ${serviceUrl}
            
            ### ğŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±
            - **ã‚µãƒ¼ãƒ“ã‚¹å**: \`${serviceName}\`
            - **ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°**: \`${imageTag}\`
            - **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³**: \`${{ env.GCP_REGION }}\`
            - **ç’°å¢ƒ**: é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰
            
            ### ğŸ”— ä¾¿åˆ©ãªãƒªãƒ³ã‚¯
            - [Cloud Run ã‚³ãƒ³ã‚½ãƒ¼ãƒ«](https://console.cloud.google.com/run/detail/${{ env.GCP_REGION }}/${serviceName})
            - [ãƒ­ã‚°ç¢ºèª](https://console.cloud.google.com/logs/query;query=resource.type%3D%22cloud_run_revision%22%0Aresource.labels.service_name%3D%22${serviceName}%22)
            
            ### âš ï¸ æ³¨æ„äº‹é …
            - ã“ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã¯PRã‚¯ãƒ­ãƒ¼ã‚ºæ™‚ã«è‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™
            - BigQueryã®ä»£ã‚ã‚Šã«ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™
            - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆç”¨é€”ã«ã¯é©ã—ã¦ã„ã¾ã›ã‚“
            
            ---
            *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã®é€šçŸ¥
  notify-result:
    runs-on: ubuntu-latest
    needs: [prepare, deploy-to-cloud-run]
    if: always()
    steps:
      - name: Notify deployment result
        run: |
          if [ "${{ needs.deploy-to-cloud-run.result }}" = "success" ]; then
            echo "âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ã¾ã—ãŸ"
            echo "ğŸŒ URL: ${{ needs.deploy-to-cloud-run.outputs.service_url }}"
            echo "ğŸ“‹ ã‚µãƒ¼ãƒ“ã‚¹å: ${{ needs.prepare.outputs.service_name }}"
          else
            echo "âŒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi