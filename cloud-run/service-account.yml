# Cloud Run å°‚ç”¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ‰‹å‹•ã§ã®GCPè¨­å®šæ™‚ã«å‚è€ƒã¨ã—ã¦ä½¿ç”¨

# 1. Cloud Run å°‚ç”¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆ
apiVersion: v1
kind: ConfigMap
metadata:
  name: cloud-run-setup-commands
data:
  create-service-account.sh: |
    #!/bin/bash
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã®è¨­å®š
    PROJECT_ID="your-gcp-project-id"
    
    # Cloud Run å°‚ç”¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆ
    gcloud iam service-accounts create cloud-run-penlight \
      --display-name="Cloud Run Penlight Quiz Service Account" \
      --description="å‚é“ãƒšãƒ³ãƒ©ã‚¤ãƒˆã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒªç”¨ã®Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ" \
      --project="$PROJECT_ID"
    
    # BigQuery èª­ã¿å–ã‚Šå°‚ç”¨æ¨©é™ã®ä»˜ä¸
    gcloud projects add-iam-policy-binding "$PROJECT_ID" \
      --member="serviceAccount:cloud-run-penlight@${PROJECT_ID}.iam.gserviceaccount.com" \
      --role="roles/bigquery.dataViewer"
    
    gcloud projects add-iam-policy-binding "$PROJECT_ID" \
      --member="serviceAccount:cloud-run-penlight@${PROJECT_ID}.iam.gserviceaccount.com" \
      --role="roles/bigquery.jobUser"
    
    # Cloud Logging æ›¸ãè¾¼ã¿æ¨©é™ã®ä»˜ä¸
    gcloud projects add-iam-policy-binding "$PROJECT_ID" \
      --member="serviceAccount:cloud-run-penlight@${PROJECT_ID}.iam.gserviceaccount.com" \
      --role="roles/logging.logWriter"
    
    # Cloud Monitoring ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›¸ãè¾¼ã¿æ¨©é™ã®ä»˜ä¸
    gcloud projects add-iam-policy-binding "$PROJECT_ID" \
      --member="serviceAccount:cloud-run-penlight@${PROJECT_ID}.iam.gserviceaccount.com" \
      --role="roles/monitoring.metricWriter"
    
    # ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã®ä½œæˆï¼ˆGitHub Secretsã§ä½¿ç”¨ï¼‰
    gcloud iam service-accounts keys create cloud-run-sa-key.json \
      --iam-account="cloud-run-penlight@${PROJECT_ID}.iam.gserviceaccount.com" \
      --project="$PROJECT_ID"
    
    echo "âœ… ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆå®Œäº†"
    echo "ğŸ“ cloud-run-sa-key.json ã‚’GitHub Secretsã®GCP_SA_KEYã«è¨­å®šã—ã¦ãã ã•ã„"

---

# 2. Artifact Registry ã®è¨­å®š
apiVersion: v1
kind: ConfigMap
metadata:
  name: artifact-registry-setup
data:
  setup-registry.sh: |
    #!/bin/bash
    
    PROJECT_ID="your-gcp-project-id"
    REGION="asia-northeast1"
    REPOSITORY="penlight"
    
    # Artifact Registry ãƒªãƒã‚¸ãƒˆãƒªã®ä½œæˆ
    gcloud artifacts repositories create "$REPOSITORY" \
      --repository-format=docker \
      --location="$REGION" \
      --description="å‚é“ãƒšãƒ³ãƒ©ã‚¤ãƒˆã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒªç”¨Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒªãƒã‚¸ãƒˆãƒª" \
      --project="$PROJECT_ID"
    
    # GitHub Actions ç”¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®æ¨©é™ä»˜ä¸
    gcloud artifacts repositories add-iam-policy-binding "$REPOSITORY" \
      --location="$REGION" \
      --member="serviceAccount:cloud-run-penlight@${PROJECT_ID}.iam.gserviceaccount.com" \
      --role="roles/artifactregistry.writer" \
      --project="$PROJECT_ID"
    
    echo "âœ… Artifact Registry ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"

---

# 3. Secret Manager ã®è¨­å®šï¼ˆBigQueryèªè¨¼æƒ…å ±ç”¨ï¼‰
apiVersion: v1
kind: ConfigMap
metadata:
  name: secret-manager-setup
data:
  setup-secrets.sh: |
    #!/bin/bash
    
    PROJECT_ID="your-gcp-project-id"
    
    # BigQueryç”¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’Secret Managerã«ä¿å­˜
    gcloud secrets create bigquery-sa-key \
      --replication-policy="automatic" \
      --project="$PROJECT_ID"
    
    # ã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«ä¿å­˜
    gcloud secrets versions add bigquery-sa-key \
      --data-file="cloud-run-sa-key.json" \
      --project="$PROJECT_ID"
    
    # Cloud Run ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆèª­ã¿å–ã‚Šæ¨©é™ã‚’ä»˜ä¸
    gcloud secrets add-iam-policy-binding bigquery-sa-key \
      --member="serviceAccount:cloud-run-penlight@${PROJECT_ID}.iam.gserviceaccount.com" \
      --role="roles/secretmanager.secretAccessor" \
      --project="$PROJECT_ID"
    
    echo "âœ… Secret Manager ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"

---

# 4. Cloud Run ã® IAM è¨­å®š
apiVersion: v1
kind: ConfigMap
metadata:
  name: cloud-run-iam-setup
data:
  setup-iam.sh: |
    #!/bin/bash
    
    PROJECT_ID="your-gcp-project-id"
    
    # GitHub Actions ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆ
    gcloud iam service-accounts create github-actions-deploy \
      --display-name="GitHub Actions Deploy Service Account" \
      --description="GitHub Actionsã‹ã‚‰Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤ç”¨" \
      --project="$PROJECT_ID"
    
    # Cloud Run ãƒ‡ãƒ—ãƒ­ã‚¤æ¨©é™ã®ä»˜ä¸
    gcloud projects add-iam-policy-binding "$PROJECT_ID" \
      --member="serviceAccount:github-actions-deploy@${PROJECT_ID}.iam.gserviceaccount.com" \
      --role="roles/run.admin"
    
    # Artifact Registry èª­ã¿å–ã‚Šæ¨©é™ã®ä»˜ä¸
    gcloud projects add-iam-policy-binding "$PROJECT_ID" \
      --member="serviceAccount:github-actions-deploy@${PROJECT_ID}.iam.gserviceaccount.com" \
      --role="roles/artifactregistry.reader"
    
    # Service Account User æ¨©é™ã®ä»˜ä¸ï¼ˆCloud Runã‚µãƒ¼ãƒ“ã‚¹ã‚’ä»–ã®SAã§å®Ÿè¡Œã™ã‚‹ãŸã‚ï¼‰
    gcloud projects add-iam-policy-binding "$PROJECT_ID" \
      --member="serviceAccount:github-actions-deploy@${PROJECT_ID}.iam.gserviceaccount.com" \
      --role="roles/iam.serviceAccountUser"
    
    # GitHub Actionsç”¨ã‚­ãƒ¼ã®ä½œæˆ
    gcloud iam service-accounts keys create github-actions-key.json \
      --iam-account="github-actions-deploy@${PROJECT_ID}.iam.gserviceaccount.com" \
      --project="$PROJECT_ID"
    
    echo "âœ… GitHub Actions IAM ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"
    echo "ğŸ“ github-actions-key.json ã‚’GitHub Secretsã®GCP_SA_KEYã«è¨­å®šã—ã¦ãã ã•ã„"